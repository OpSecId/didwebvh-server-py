"""SQLAlchemy database models."""

from sqlalchemy import Column, String, Text, Boolean, DateTime, JSON, Index, ForeignKey
from sqlalchemy.sql import func

from .base import Base


# Type aliases for cleaner code (defined after classes below)
# These are forward references, actual assignments are at the end of this file


class DidController(Base):
    """Base class for all DID controller-related records."""
    
    __tablename__ = "did_controllers"
    
    # Primary key
    scid = Column(String(255), primary_key=True, index=True)
    
    # DID information (not primary key - each model defines its own)
    did = Column(String(500), nullable=False, index=True)
    domain = Column(String(255), nullable=False, index=True)
    namespace = Column(String(255), nullable=False, index=True)
    alias = Column(String(255), nullable=False, index=True)
    
    # Composite indexes
    __table_args__ = (
        Index('idx_namespace_alias', 'namespace', 'alias'),
    )


class LogFileRecord(Base):
    """DID log entries table."""

    __tablename__ = "log_files"
    
    # Primary key
    scid = Column(String(255), ForeignKey('did_controllers.scid'), primary_key=True)
    
    # DID information (indexed for querying)
    did = Column(String(500), nullable=False, index=True)
    domain = Column(String(255), nullable=False, index=True)
    namespace = Column(String(255), nullable=False, index=True)
    alias = Column(String(255), nullable=False, index=True)
    
    # Status
    deactivated = Column(Boolean, default=False, index=True)
    
    # Data
    logs = Column(JSON, nullable=False)
    state = Column(JSON, nullable=False)
    # witness = Column(JSON, nullable=False)
    parameters = Column(JSON, nullable=False)
    
    # Timestamps
    created = Column(DateTime(timezone=True), server_default=func.now(), nullable=False)
    updated = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), nullable=False)
    
    # MediaType
    media_type = Column(String(255), nullable=False, default="application/jsonl")
    
    # Composite indexes
    __table_args__ = (
        Index('idx_log_namespace_alias', 'namespace', 'alias'),
    )

class WitnessFileRecord(Base):
    """Witness files table."""

    __tablename__ = "witness_files"
    
    # Primary key
    scid = Column(String(255), primary_key=True, index=True)
    
    # DID information (indexed for querying)
    did = Column(String(500), nullable=False, index=True)
    domain = Column(String(255), nullable=False, index=True)
    namespace = Column(String(255), nullable=False, index=True)
    alias = Column(String(255), nullable=False, index=True)
    
    # Data
    witness_proofs = Column(JSON, nullable=False)
    
    # MediaType
    media_type = Column(String(255), nullable=False, default="application/json")
    
    # Composite indexes
    __table_args__ = (
        Index('idx_witness_namespace_alias', 'namespace', 'alias'),
    )

class WhoisVpRecord(Base):
    """WHOIS presentations table."""

    __tablename__ = "whois_presentations"
    
    # Primary key
    scid = Column(String(255), primary_key=True, index=True)
    
    # DID information (indexed for querying)
    did = Column(String(500), nullable=False, index=True)
    domain = Column(String(255), nullable=False, index=True)
    namespace = Column(String(255), nullable=False, index=True)
    alias = Column(String(255), nullable=False, index=True)
    
    # Data
    presentation = Column(JSON, nullable=False)
    
    # MediaType
    media_type = Column(String(255), nullable=False, default='application/vp')
    
    # Composite indexes
    __table_args__ = (
        Index('idx_whois_namespace_alias', 'namespace', 'alias'),
    )

class AttestedResourceRecord(Base):
    """Attested resources table."""

    __tablename__ = "attested_resources"

    # Primary key
    resource_id = Column(String(255), primary_key=True, index=True)
    
    # Relationships
    
    scid = Column(String(255), ForeignKey('did_controllers.scid'), primary_key=False)
    
    # Resource information
    resource_type = Column(String(100), nullable=False, index=True)
    resource_name = Column(String(255), nullable=False)
    
    # Resource data
    attested_resource = Column(JSON, nullable=False)
    
    # MediaType
    media_type = Column(String(255), nullable=False, default='application/jsonld')


class AdminBackgroundTask(Base):
    """Background tasks table."""

    __tablename__ = "admin_background_tasks"

    # Primary key
    task_id = Column(String(36), primary_key=True, index=True)
    
    # Task information
    task_type = Column(String(50), nullable=False, index=True)
    status = Column(String(20), nullable=False, index=True)
    
    # Task data
    progress = Column(JSON, default={})
    message = Column(Text)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now(), nullable=False)
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), nullable=False)
    
    # Composite index
    __table_args__ = (
        Index('idx_task_type_status', 'task_type', 'status'),
    )


class ServerPolicy(Base):
    """Server policies table."""

    __tablename__ = "server_policies"

    # Primary key
    policy_id = Column(String(50), primary_key=True)
    
    # Policy data
    version = Column(String(20))
    witness = Column(Boolean, default=False)
    watcher = Column(String(500))
    portability = Column(Boolean, default=False)
    prerotation = Column(Boolean, default=False)
    endorsement = Column(Boolean, default=False)
    witness_registry_url = Column(String(500))
    
    # Full policy as JSON (for extensibility)
    policy_data = Column(JSON)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now(), nullable=False)
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), nullable=False)


class KnownWitnessRegistry(Base):
    """Registries table (e.g., known witnesses)."""

    __tablename__ = "known_witness_registries"

    # Primary key
    registry_id = Column(String(50), primary_key=True)
    
    # Registry data
    registry_type = Column(String(50), nullable=False, index=True)
    registry_data = Column(JSON, nullable=False)
    
    # Metadata
    meta = Column(JSON)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now(), nullable=False)
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), nullable=False)


# For test data (used by load testing)
class TestLogEntry(Base):
    """Test log entries table (for load testing)."""

    __tablename__ = "test_log_entries"

    # Primary key
    scid = Column(String(255), primary_key=True, index=True)
    
    # Test data
    logs = Column(JSON, nullable=False)
    tags = Column(JSON)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now(), nullable=False)


class TestResource(Base):
    """Test resources table (for load testing)."""

    __tablename__ = "test_resources"

    # Primary key
    resource_id = Column(String(255), primary_key=True, index=True)
    
    # Test data
    resource_data = Column(JSON, nullable=False)
    tags = Column(JSON)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now(), nullable=False)


# Type aliases removed - use full model names directly

